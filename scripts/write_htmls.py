# -*- coding: utf-8 -*-
# @Time    : 2023/12/27 9:43
# @Author  : vvmdx
# @File    : write_htmls.py
# @Project : CVE-news
import datetime

new_entries_html_template = """
<tr style="height: 30px;">
    <td><a href="{cve_hyperlink}" target="_blank" rel="noopener">{cve_id}</a></td>
    <td>{cvss_score}</td>
    <td>{cvss_severity}</td>
</tr>
"""

modified_entries_html_template = """
<tr style="height: 30px;">
    <td><a href="{cve_hyperlink}" target="_blank" rel="noopener">{cve_id}</a></td>
    <td>{cvss_score}</td>
    <td>{cvss_severity}</td>
    <td>{changes}</td>
</tr>
"""

references_template = """
    <li><a href="{reference_hyperlink}" target="_blank" rel="noopener">{reference}</a></li>
"""

new_cve_details_template = """
    <p><span style="font-size: 14pt;"><strong>{cve_id}</strong></span></p>
    <p>CVSS V3：{cvss_score}</p>
    <p>漏洞等级：{cvss_severity}</p>
    <p>漏洞描述：{descriptions}</p>
    <p>参考资料：</p>
    <ol>{references}</ol>
"""

modified_cve_details_template = """
    <p><span style="font-size: 14pt;"><strong>{cve_id}</strong></span></p>
    <p>CVSS V3：{cvss_score}</p>
    <p>漏洞等级：{cvss_severity}</p>
    <p>更新的地方：{changes}</p>
    <p>漏洞描述：{descriptions}</p>
    <p>参考资料：</p>
    <ol>{references}</ol>
"""


def write_html(cve_dict):
    # with open("../html/template.html", "r", encoding="utf-8") as file:
    with open("template.html", "r", encoding="utf-8") as file:
        template = file.read()
    yesterday = datetime.date.today()
    new_entries, new_cve_details, modified_entries, modified_cve_details = set_html(cve_dict)
    result = template.format(date=yesterday, new_entries=new_entries, modified_entries=modified_entries, new_cve_details=new_cve_details, modified_cve_details=modified_cve_details)

    print(result)
    return result


def set_html(cve_dict):
    new_entries_dict = cve_dict["new_entries"]
    new_entries = ""
    new_cve_details = ""
    for cve_detail in new_entries_dict:
        link = cve_detail["mitre"]
        id = cve_detail["id"]
        score = cve_detail["baseScore"]
        severity = cve_detail["severity"]
        descriptions = cve_detail["descriptions"]
        ref_list = ""
        for reference in cve_detail["references"]:
            ref_list += references_template.format(reference_hyperlink=reference, reference=reference)
        tmp_1 = new_entries_html_template.format(cve_hyperlink=link, cve_id=id,
                                               cvss_score=score, cvss_severity=severity)
        new_entries += tmp_1

        tmp_2 = new_cve_details_template.format(cve_id=id, cvss_score=score, cvss_severity=severity,
                                       descriptions=descriptions, references=ref_list)
        new_cve_details += tmp_2

    # 复用代码很多。。。懒得优化了
    modified_entries_dict = cve_dict["modified_entries"]
    modified_entries = ""
    modified_cve_details = ""
    for cve_detail in modified_entries_dict:
        link = cve_detail["mitre"]
        id = cve_detail["id"]
        score = cve_detail["baseScore"]
        change = cve_detail["changes"]
        severity = cve_detail["severity"]
        descriptions = cve_detail["descriptions"]
        ref_list = ""
        for reference in cve_detail["references"]:
            ref_list += references_template.format(reference_hyperlink=reference, reference=reference)
        tmp_1 = modified_entries_html_template.format(cve_hyperlink=link, cve_id=id,
                                               cvss_score=score, cvss_severity=severity, changes=change)
        modified_entries += tmp_1

        tmp_2 = modified_cve_details_template.format(cve_id=id, cvss_score=score, cvss_severity=severity,
                                       changes=change, descriptions=descriptions, references=ref_list)
        modified_cve_details += tmp_2

    return new_entries, new_cve_details, modified_entries, modified_cve_details
